{% extends 'base.html' %}
{% load static %}
    
    <title>Board-create</title>
    {% block extra-style %}
    <script src="https://kit.fontawesome.com/a47086679e.js" crossorigin="anonymous"></script>
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
  
    <!-- Plugin -->
    <link rel="stylesheet" href="https://rawgit.com/enyo/dropzone/master/dist/dropzone.css" />
    <script src="https://rawgit.com/enyo/dropzone/master/dist/dropzone.js"></script>

    <style>
        body {
        background: #EEE;
        font-family: 'Roboto', sans-serif;
        }
        .container {
            background: #fff;
        }
        .create-header {
            padding: 20px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
        }
        .create-header h1 {
            margin: 0; /* margin ì œê±° */
            display: flex; /* Flexbox ì»¨í…Œì´ë„ˆë¡œ ì„¤ì • */
            align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
        }

        .dropzone {
            margin: 0 20px;
            width: 98%;
            margin: 1%;
            border: 2px dashed #3498db !important;
            border-radius: 5px;
            -webkit-transition: .2s;
            transition: .2s;
        }

        .dropzone.dz-drag-hover {
            border: 2px solid #3498db !important;
        }

        .dz-message.needsclick img {
        width: 50px;
        display: block;
        margin: auto;
        opacity: .6;
        margin-bottom: 15px;
        }

        span.plus {
        display: none;
        }

        .dropzone.dz-started .dz-message {
            display: inline-block !important;
            width: 120px;
            float: right;
            border: 1px solid rgba(238, 238, 238, 0.36);
            border-radius: 30px;
            height: 120px;
            margin: 16px;
            -webkit-transition: .2s;
            transition: .2s;
        }

        .dropzone.dz-started .dz-message span.text {
        display: none;
        }

        .dropzone.dz-started .dz-message span.plus {
        display: block;
        font-size: 70px;
        color: #AAA;
        line-height: 110px;
        }        

        /* ë¯¸ë¦¬ë³´ê¸° */
        .preview-container {
            padding: 20px 20px;

            
        }
        .preview-image-container {
            display: flex; 
            justify-content: center; 
            align-items: center; 
            flex-direction: column; 
        }

        .preview-image {
            display: none;
            max-width: 70%; /* ìˆ˜ì •ëœ ë¶€ë¶„ */
            height: auto;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        /* dropzone ê¸°ë³¸ì œê³µ Remove file ë¬¸ìì—´ê³¼ ì‚¬ìš©ìì»¤ìŠ¤í…€ xë²„íŠ¼ì´ ê²¹ì¹˜ëŠ” ì´ìŠˆ */
        .dz-remove {
            display: none; /* ê¸°ë³¸ í…ìŠ¤íŠ¸ë¥¼ ìˆ¨ê¹€ */
        }
        /* ì‚¬ìš©ì ì •ì˜ x ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¡°ì • */
        .dz-remove.custom-remove {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 25px;
            height: 25px;
            background: #373634;
            color: white;
            border-radius: 50%;
            line-height: 25px;
            text-align: center;
            cursor: pointer;
            z-index: 1000;
            opacity: 0.8;

            display: flex; /* í”Œë ‰ìŠ¤ë°•ìŠ¤ë¡œ ì„¤ì • */
            justify-content: center; /* ê°€ìš´ë° ì •ë ¬ */
            align-items: center; /* ê°€ìš´ë° ì •ë ¬ */

        }

        .dz-remove.custom-remove:hover {
            background-color: rgb(90, 129, 151);
        }

        .dz-remove.custom-remove:before, .dz-remove.custom-remove:after {
            content: ' ';
            position: absolute;
            width: 2px;
            height: 20px;
            background-color: #fff;
        }

        .dz-remove.custom-remove:before {
            transform: rotate(45deg);
            left: 11px;
            top: 2px;
        }

        .dz-remove.custom-remove:after {
            transform: rotate(-45deg);
            left: 11px;
            top: 2px;
        }
        .nextbutton {
            border: none;
        }
    </style>
    {% endblock %}

    {% block content %}
    <div class="container mt-5">
        <div class="create-header">
            <h1>ìƒˆ í¬ìŠ¤íŠ¸ ìƒì„±</h1>
            <form action="{% url 'board:board_create_form' %}" method="post" id="nextForm">
                {% csrf_token%}
                <button type="submit" class="btn btn-outline-secondary nextbutton">ë‹¤ìŒ</button>
                <input type="hidden" name = "" value="">
            </form>
        </div>
        

        <div id="dropzone">
            <form action="{% url 'board:temp_upload' %}" id="demo-upload" class="dropzone needsclick" >
                {% csrf_token%}
                <div class="dz-message needsclick">
                    <span class="text">
                    <img src="http://www.freeiconspng.com/uploads/------------------------------iconpngm--22.png" alt="Camera" />
                    ğŸ‘‰  ì—¬ê¸°ì— íŒŒì¼ì„ ëŒì–´ë‹¤ ë†“ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”. ğŸ‘ˆ
                    </span>
                    <span class="plus">+</span>
                </div>
            </form>
        </div>

        <div class="preview-container">
            <h1>ë¯¸ë¦¬ë³´ê¸°</h1>
            <p>â•ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ì„¸ìš”.</p>
            <div id="preview-container" class="preview-image-container mt-3">
                <img id="preview-image" class="preview-image" src="" alt="Preview">
                
            </div>
        </div>
    </div>

<script>
    // ì‚¬ì´ì¦ˆê°€ í° ì´ë¯¸ì§€ ì‚¬ì´ì¦ˆ ì¤„ì´ê¸°
    function resizeImage(file, maxWidth, maxHeight, callback) {
        const img = document.createElement("img");
        const reader = new FileReader();
        
        reader.onload = function(e) {
            img.src = e.target.result;
            img.onload = function() {
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width *= maxHeight / height;
                        height = maxHeight;
                    }
                }

                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);

                let quality = 0.9;  // ì´ˆê¸° í€„ë¦¬í‹°
                canvas.toBlob(function(blob) {
                if (blob.size <= 2 * 1024 * 1024) {
                    callback(blob);
                } else {
                    iterateQuality(blob, quality, callback);
                }
            }, file.type, quality);
            }
        };
        reader.readAsDataURL(file);
    }

    function iterateQuality(blob, quality, callback) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.src = e.target.result;
            img.onload = function() {
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0, img.width, img.height);

                quality -= 0.1;
                canvas.toBlob(function(newBlob) {
                    if (newBlob.size <= 2 * 1024 * 1024 || quality <= 0.1) {
                        callback(newBlob);
                    } else {
                        iterateQuality(newBlob, quality, callback);
                    }
                }, blob.type, quality);
            }
        };
        reader.readAsDataURL(blob);
    }

    // ë“œë˜ê·¸ì•¤ë“œë¡­ 
    Dropzone.options.demoUpload = {
        // sessionStorageê·œê²©
        paramName: "file", // íŒŒì¼ ì´ë¦„
        acceptedFiles: ".jpeg,.jpg,.png,.gif", // í—ˆìš©í•  íŒŒì¼ í™•ì¥ì
        addRemoveLinks: true, // íŒŒì¼ ì œê±° ë§í¬ í‘œì‹œ
        dictDefaultMessage: "ì—¬ê¸°ì— íŒŒì¼ì„ ë“œë¡­í•˜ì„¸ìš”", // ê¸°ë³¸ ë©”ì‹œì§€
        dictRemoveFile: "", // ê¸°ë³¸ "Remove file" í…ìŠ¤íŠ¸ë¥¼ ìˆ¨ê¹€

        init: function() {
            var _this = this;
            var totalFileSize = 0; // ì „ì²´ íŒŒì¼ ì‚¬ì´ì¦ˆë¥¼ ì¶”ì í•˜ê¸° ìœ„í•œ ë³€ìˆ˜

             // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ íŒŒì¼ ë³µì›
            var storedFiles = JSON.parse(sessionStorage.getItem('uploadedFiles') || '[]');
            storedFiles.forEach(function(fileData) {
                var mockFile = { 
                    name: fileData.name, 
                    size: fileData.size, 
                    type: fileData.type, 
                    // dataUrl: fileData.dataUrl 
                };
                _this.emit("addedfile", mockFile);
                // _this.createThumbnailFromUrl(mockFile, fileData.dataUrl);
                _this.emit("thumbnail", mockFile, fileData.dataUrl);
                _this.emit("complete", mockFile);
                
                console.log(mockFile);
                // ì‚¬ìš©ì ì •ì˜ x ë²„íŠ¼ ì¶”ê°€
                var removeButton = Dropzone.createElement("<button class='dz-remove custom-remove'></button>");
                removeButton.setAttribute('data-dz-remove', '');
                mockFile.previewElement.appendChild(removeButton);

                removeButton.addEventListener("click", function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    _this.removeFile(mockFile); // Dropzoneì—ì„œ íŒŒì¼ ì œê±°

                    // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œë„ íŒŒì¼ ì œê±°
                    var sessionFiles = JSON.parse(sessionStorage.getItem('uploadedFiles') || '[]');
                    var updatedSessionFiles = sessionFiles.filter(function(f) {
                        return f.name !== mockFile.name;
                    });
                    sessionStorage.setItem('uploadedFiles', JSON.stringify(updatedSessionFiles));
                });
                // var reader = new FileReader();

                // reader.onload = function(event) {
                //     file.previewElement.addEventListener("click", function(e) {
                //         // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
                //         if (e.target.classList.contains('dz-remove')) return;

                //         var previewImage = document.getElementById('preview-image');
                //         previewImage.src = event.target.result;
                //         previewImage.style.display = 'block';
                //         });
                // };

                // Dropzoneì— íŒŒì¼ ê°ì²´ë¥¼ ì¶”ê°€
                _this.files.push(mockFile);

                // íŒŒì¼ í´ë¦­ ì´ë²¤íŠ¸ ì„¤ì •
                mockFile.previewElement.addEventListener("click", function (e) {
                    if (e.target.classList.contains('dz-remove')) return;

                    var previewImage = document.getElementById('preview-image');
                    previewImage.src = fileData.dataUrl;
                    previewImage.style.display = 'block';
                });
            });



            this.on("success", function(file, response) {
                var sessionFiles = sessionStorage.getItem('uploadedFiles') ? JSON.parse(sessionStorage.getItem('uploadedFiles')) : [];
                if (file.size > 2 * 1024 * 1024) {
                    resizeImage(file, 845.33, 600, function(resizedBlob) {
                        saveToSessionStorage(file, resizedBlob, sessionFiles);
                    });
                } else {
                    saveToSessionStorage(file, file, sessionFiles);
                }
            });

              

            // this.on("removedfile", function(file) {
            //     var sessionFiles = JSON.parse(sessionStorage.getItem('uploadedFiles') || '[]');
            //     var updatedSessionFiles = sessionFiles.filter(function(f) {
            //         return f.name !== file.name;
            //     });
            //     sessionStorage.setItem('uploadedFiles', JSON.stringify(updatedSessionFiles));

            //     // Dropzoneì—ì„œë„ íŒŒì¼ ê°ì²´ë¥¼ ì°¾ì•„ì„œ ì‚­ì œ
            //     var existingFile = _this.files.find(function(f) {
            //         return f.name === file.name && f.size === file.size && f.type === file.type && f.dataUrl === file.dataUrl;
            //     });
            //     if (existingFile) {
            //         _this.removeFile(existingFile);
            //     }
            //     // Dropzoneì—ì„œ íŒŒì¼ ê°ì²´ ì œê±°
            //     _this.files = _this.files.filter(function(f) {
            //         return f.name !== file.name;
            //     });

            //     // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œë„ íŒŒì¼ ì œê±°
            //     var sessionFiles = JSON.parse(sessionStorage.getItem('uploadedFiles') || '[]');
            //     var updatedSessionFiles = sessionFiles.filter(function(f) {
            //         return f.name !== file.name;
            //     });
            //     sessionStorage.setItem('uploadedFiles', JSON.stringify(updatedSessionFiles));
            
            // });
                        
                // Dropzone ì»¨í…Œì´ë„ˆì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            this.element.addEventListener("click", function(e) {
                if (e.target.classList.contains('dz-remove')) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    var fileElement = e.target.closest('.dz-preview');
                    if (fileElement) {
                        var fileName = fileElement.querySelector(".dz-filename").innerText.trim(); // íŒŒì¼ ì´ë¦„ ê°€ì ¸ì˜´
                        console.log(fileElement);
                        var file = _this.getAcceptedFiles().find(function(f) {
                            console.log(f);
                            // return f.name === fileElement.file.name;
                            return f.name === fileName;
                        });
                        
                        if (file) {
                            console.log("Removing file:", file.name);
                            _this.removeFile(file);

                            // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œë„ íŒŒì¼ ì œê±°
                            var sessionFiles = JSON.parse(sessionStorage.getItem('uploadedFiles') || '[]');
                            var updatedSessionFiles = sessionFiles.filter(function(f) {
                                return f.name !== file.name;
                            });
                            sessionStorage.setItem('uploadedFiles', JSON.stringify(updatedSessionFiles));
                        } else {
                            console.error("File not found");
                        }
                    } else {
                        console.error("File element not found");
                    }
                }
            });

            this.on("addedfile", function(file) { // "thumbnail" ì´ë²¤íŠ¸ì—ì„œ "addedfile" ì´ë²¤íŠ¸ë¡œ ë³€ê²½
                totalFileSize += file.size / 1024 / 1024; // íŒŒì¼ ì‚¬ì´ì¦ˆë¥¼ MBë¡œ ë³€í™˜í•˜ì—¬ ì¶”ê°€
                    if (totalFileSize > 10) {
                        this.removeFile(file);
                        alert("ì „ì²´ íŒŒì¼ í¬ê¸°ê°€ 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    } else {
                        console.log("File added:", file.name);
                        var removeButton = Dropzone.createElement("<button class='dz-remove custom-remove'></button>");
                        removeButton.setAttribute('data-dz-remove', '');
                        file.previewElement.appendChild(removeButton);
                        // íŒŒì¼ ê°ì²´ë¥¼ previewElementì— ì§ì ‘ ì—°ê²°
                        file.previewElement.file = file;
                
                        // íŒŒì¼ì„ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                        var reader = new FileReader();
                        reader.onload = function(event) {
                            file.previewElement.addEventListener("click", function(e) {
                                // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
                                if (e.target.classList.contains('dz-remove')) return;

                                var previewImage = document.getElementById('preview-image');
                                previewImage.src = event.target.result;
                                previewImage.style.display = 'block';
                               });
                        };
                    reader.readAsDataURL(file);
                }
            });

            this.on("removedfile", function(file) {
                totalFileSize -= file.size / 1024 / 1024; // íŒŒì¼ ì œê±° ì‹œ í¬ê¸°ë„ ì¤„ì„
                // Dropzoneì—ì„œ íŒŒì¼ ê°ì²´ ì œê±°
                _this.files = _this.files.filter(function(f) {
                    return f.name !== file.name;
                });
                // íŒŒì¼ì´ ì œê±°ë  ë•Œ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œë„ ì œê±°
                var sessionFiles = JSON.parse(sessionStorage.getItem('uploadedFiles') || '[]');
                var updatedSessionFiles = sessionFiles.filter(function(f) {
                    return f.name !== file.name;
                });
                sessionStorage.setItem('uploadedFiles', JSON.stringify(updatedSessionFiles));

                // Dropzoneì—ì„œë„ íŒŒì¼ ê°ì²´ë¥¼ ì°¾ì•„ì„œ ì‚­ì œ
                var existingFile = _this.files.find(function(f) {
                    return f.name === file.name && f.size === file.size && f.type === file.type && f.dataUrl === file.dataUrl;
                });
                if (existingFile) {
                    _this.removeFile(existingFile);
                }
            });

            
        }
    };

    function saveToSessionStorage(file, blob, sessionFiles) {
        var reader = new FileReader();
        reader.onload = function(event) {
            sessionFiles.push({
                name: file.name,
                size: file.size,
                type: file.type,
                dataUrl: event.target.result
            });
            sessionStorage.setItem('uploadedFiles', JSON.stringify(sessionFiles));
        };
        reader.readAsDataURL(blob);
    }

    // ë‹¤ìŒ ë²„íŠ¼ í´ë¦­ ì‹œ ë°ì´í„° hidden inputìœ¼ë¡œ í¼ì— ì¶”ê°€
    document.getElementById('nextForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var uploadedFiles = sessionStorage.getItem('uploadedFiles');
        if (uploadedFiles) {
            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'uploadedFiles';
            input.value = uploadedFiles;
            this.appendChild(input);
        }
        this.submit();
    });

    
           
</script>
{% endblock %}